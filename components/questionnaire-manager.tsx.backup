'use client';

import React, { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Edit, Save, X, Plus, Trash2, Eye, EyeOff } from 'lucide-react';
import { 
  getQuestionnaireContent, 
  saveQuestionnaireContent, 
  resetQuestionnaireContent,
  QuestionnaireContent
} from '@/lib/questionnaire-data';

interface QuestionOption {
  id: string;
  text: string;
  hasInput?: boolean;
  inputPlaceholder?: string;
}

interface Question {
  id: string;
  title: string;
  type: 'checkbox' | 'radio' | 'text' | 'textarea' | 'number';
  options?: QuestionOption[];
  placeholder?: string;
  required?: boolean;
  isVisible: boolean;
}

interface Section {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
  isVisible: boolean;
}

interface QuestionnaireData {
  title: string;
  subtitle: string;
  logoText: string;
  sections: Section[];
  footer: {
    thankYouTitle: string;
    thankYouMessage: string;
    nextStepsTitle: string;
    nextSteps: string[];
    contactInfo: string[];
    tagline: string;
  };
}

const defaultQuestionnaireData: QuestionnaireData = {
  title: "üìã BULK ORDER CLIENT QUESTIONNAIRE",
  subtitle: "Limen Lakay LLC - Custom Order Information",
  logoText: "LL",
  sections: [
    {
      id: "section1",
      title: "SECTION 1: ORDER DETAILS & QUANTITIES",
      description: "",
      isVisible: true,
      questions: [
        {
          id: "q1-1",
          title: "What is your desired order quantity?",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "50-100 candles" },
            { id: "opt2", text: "101-200 candles" },
            { id: "opt3", text: "201-500 candles" },
            { id: "opt4", text: "500+ candles" },
            { id: "opt5", text: "vessels" },
            { id: "opt6", text: "Exact quantity (if known):", hasInput: true, inputPlaceholder: "Enter exact quantity" }
          ]
        },
        {
          id: "q1-2",
          title: "Is this a one-time order, or do you anticipate recurring orders?",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "One-time order" },
            { id: "opt2", text: "Recurring orders (monthly, quarterly, etc.)" },
            { id: "opt3", text: "If recurring, estimated frequency:", hasInput: true, inputPlaceholder: "e.g., monthly, quarterly" }
          ]
        },
        {
          id: "q1-3",
          title: "When do you need this order delivered by? (Note: Standard lead time is 2 months)",
          type: "text",
          isVisible: true,
          placeholder: "Target delivery date",
          options: [
            { id: "opt1", text: "Is this date flexible?" },
            { id: "opt2", text: "Is this a rush order?" }
          ]
        }
      ]
    },
    {
      id: "section2",
      title: "SECTION 2: PRODUCT SPECIFICATIONS",
      description: "",
      isVisible: true,
      questions: [
        {
          id: "q2-1",
          title: "What candle size(s) are you interested in?",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "Small (4-6 oz)" },
            { id: "opt2", text: "Medium (8-10 oz)" },
            { id: "opt3", text: "Large (12-16 oz)" },
            { id: "opt4", text: "Multiple sizes (please specify):", hasInput: true, inputPlaceholder: "Specify sizes" }
          ]
        },
        {
          id: "q2-2",
          title: "Container/Vessel preference",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "Cement vessels" }
          ]
        },
        {
          id: "q2-3",
          title: "What scent(s) would you like?",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "Choose from your existing collection (which ones?):", hasInput: true },
            { id: "opt2", text: "Custom scent blend (describe):", hasInput: true },
            { id: "opt3", text: "Unscented" },
            { id: "opt4", text: "Multiple scents (please specify breakdown):", hasInput: true }
          ]
        }
      ]
    }
    // Note: Section 3 (Vessel Selection) is managed separately via Vessel Manager
    // Additional sections would be added here
  ],
  footer: {
    thankYouTitle: "Thank You for Your Interest!",
    thankYouMessage: "We're excited about the possibility of working together to create beautiful, eco-friendly candles for your project.",
    nextStepsTitle: "Next Steps:",
    nextSteps: [
      "Download this completed PDF",
      "Email it to: info@limenlakay.com",
      "We'll respond within 24-48 hours with a custom quote and timeline"
    ],
    contactInfo: [
      "Limen Lakay LLC ‚Ä¢ Handmade Eco-Friendly Candles",
      "üìß info@limenlakay.com ‚Ä¢ üåê www.limenlakay.com"
    ],
    tagline: "\"Illuminating spaces, naturally.\""
  }
};

// Storage key
const QUESTIONNAIRE_DATA_KEY = 'limen-lakay-questionnaire-data';

export default function QuestionnaireManager() {
  const [data, setData] = useState<QuestionnaireData>(defaultQuestionnaireData);
  const [editingItem, setEditingItem] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<Partial<QuestionnaireContent>>({});
  const [showPreview, setShowPreview] = useState(false);

  // Load data on mount
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(QUESTIONNAIRE_DATA_KEY);
      if (stored) {
        try {
          setData(JSON.parse(stored));
        } catch (error) {
          console.error('Failed to load questionnaire data:', error);
        }
      }
    }
  }, []);

  // Save data when it changes
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem(QUESTIONNAIRE_DATA_KEY, JSON.stringify(data));
    }
  }, [data]);

  const startEdit = (itemId: string, currentData: any) => {
    setEditingItem(itemId);
    setEditForm(currentData);
  };

  const saveEdit = () => {
    if (!editingItem) return;

    if (editingItem === 'header') {
      setData(prev => ({
        ...prev,
        title: editForm.title,
        subtitle: editForm.subtitle,
        logoText: editForm.logoText
      }));
    } else if (editingItem === 'footer') {
      setData(prev => ({
        ...prev,
        footer: editForm
      }));
    } else if (editingItem.startsWith('section-')) {
      const sectionId = editingItem.replace('section-', '');
      setData(prev => ({
        ...prev,
        sections: prev.sections.map(section =>
          section.id === sectionId
            ? { ...section, title: editForm.title, description: editForm.description }
            : section
        )
      }));
    } else if (editingItem.startsWith('question-')) {
      const [sectionId, questionId] = editingItem.replace('question-', '').split('-');
      setData(prev => ({
        ...prev,
        sections: prev.sections.map(section =>
          section.id === `section${sectionId}`
            ? {
                ...section,
                questions: section.questions.map(question =>
                  question.id === `q${sectionId}-${questionId}`
                    ? { ...question, title: editForm.title, placeholder: editForm.placeholder }
                    : question
                )
              }
            : section
        )
      }));
    }

    setEditingItem(null);
    setEditForm({});
  };

  const cancelEdit = () => {
    setEditingItem(null);
    setEditForm({});
  };

  const toggleSectionVisibility = (sectionId: string) => {
    setData(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? { ...section, isVisible: !section.isVisible }
          : section
      )
    }));
  };

  const toggleQuestionVisibility = (sectionId: string, questionId: string) => {
    setData(prev => ({
      ...prev,
      sections: prev.sections.map(section =>
        section.id === sectionId
          ? {
              ...section,
              questions: section.questions.map(question =>
                question.id === questionId
                  ? { ...question, isVisible: !question.isVisible }
                  : question
              )
            }
          : section
      )
    }));
  };

  const addNewSection = () => {
    const newSectionNumber = data.sections.length + 1;
    const newSection: Section = {
      id: `section${newSectionNumber}`,
      title: `SECTION ${newSectionNumber}: NEW SECTION`,
      description: "Add your description here",
      isVisible: true,
      questions: [
        {
          id: `q${newSectionNumber}-1`,
          title: "New question - click edit to modify",
          type: "checkbox",
          isVisible: true,
          options: [
            { id: "opt1", text: "Option 1" },
            { id: "opt2", text: "Option 2" }
          ]
        }
      ]
    };

    setData(prev => ({
      ...prev,
      sections: [...prev.sections, newSection]
    }));
  };

  const deleteSection = (sectionId: string) => {
    if (confirm('Are you sure you want to delete this section?')) {
      setData(prev => ({
        ...prev,
        sections: prev.sections.filter(section => section.id !== sectionId)
      }));
    }
  };

  const exportConfiguration = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `questionnaire-config-${new Date().getTime()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-start">
        <div>
          <h2 className="text-2xl font-bold text-[#5D4037] mb-2">Questionnaire Content Manager</h2>
          <p className="text-gray-600">Edit all questionnaire text, questions, and structure</p>
        </div>
        <div className="flex gap-2">
          <Button 
            onClick={() => setShowPreview(!showPreview)}
            variant="outline"
            className="flex items-center gap-2"
          >
            {showPreview ? <EyeOff size={16} /> : <Eye size={16} />}
            {showPreview ? 'Hide Preview' : 'Show Preview'}
          </Button>
          <Button onClick={addNewSection} className="bg-[#8B6F47] hover:bg-[#6D4C41]">
            <Plus size={16} className="mr-2" />
            Add Section
          </Button>
          <Button onClick={exportConfiguration} variant="outline">
            Export Config
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card className="p-4">
          <div className="text-2xl font-bold text-[#8B6F47]">{data.sections.length}</div>
          <div className="text-sm text-gray-600">Total Sections</div>
        </Card>
        <Card className="p-4">
          <div className="text-2xl font-bold text-green-600">
            {data.sections.filter(s => s.isVisible).length}
          </div>
          <div className="text-sm text-gray-600">Visible Sections</div>
        </Card>
        <Card className="p-4">
          <div className="text-2xl font-bold text-blue-600">
            {data.sections.reduce((acc, s) => acc + s.questions.length, 0)}
          </div>
          <div className="text-sm text-gray-600">Total Questions</div>
        </Card>
        <Card className="p-4">
          <div className="text-2xl font-bold text-purple-600">
            {data.sections.reduce((acc, s) => acc + s.questions.filter(q => q.isVisible).length, 0)}
          </div>
          <div className="text-sm text-gray-600">Visible Questions</div>
        </Card>
      </div>

      {/* Preview Mode */}
      {showPreview && (
        <Card className="p-6 bg-blue-50 border-blue-200">
          <h3 className="text-lg font-semibold mb-4 text-blue-900">Live Preview</h3>
          <div className="bg-white p-6 rounded-lg border max-h-96 overflow-y-auto">
            <div className="text-center mb-6">
              <div className="text-3xl font-bold text-[#5D4037] mb-2">{data.title}</div>
              <div className="text-lg text-[#8D6E63]">{data.subtitle}</div>
            </div>
            {data.sections.filter(s => s.isVisible).map(section => (
              <div key={section.id} className="mb-6">
                <div className="bg-[#8B6F47] text-white px-4 py-2 font-semibold rounded-r-lg inline-block mb-4">
                  {section.title}
                </div>
                {section.questions.filter(q => q.isVisible).map(question => (
                  <div key={question.id} className="mb-4">
                    <h4 className="font-semibold mb-2">{question.title}</h4>
                    <div className="space-y-1 ml-4 text-sm text-gray-600">
                      {question.options?.slice(0, 3).map(option => (
                        <div key={option.id}>‚Ä¢ {option.text}</div>
                      ))}
                      {question.options && question.options.length > 3 && (
                        <div>... and {question.options.length - 3} more options</div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </Card>
      )}

      {/* Header Editor */}
      <Card className="p-6">
        <div className="flex justify-between items-start mb-4">
          <h3 className="text-lg font-semibold">Questionnaire Header</h3>
          <Button 
            size="sm" 
            variant="outline" 
            onClick={() => startEdit('header', {
              title: data.title,
              subtitle: data.subtitle,
              logoText: data.logoText
            })}
          >
            <Edit size={14} />
          </Button>
        </div>

        {editingItem === 'header' ? (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">Main Title:</label>
              <input
                type="text"
                value={editForm.title || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, title: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Subtitle:</label>
              <input
                type="text"
                value={editForm.subtitle || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, subtitle: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Logo Text:</label>
              <input
                type="text"
                value={editForm.logoText || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, logoText: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div className="flex gap-2">
              <Button onClick={saveEdit} className="bg-green-600 hover:bg-green-700">
                <Save size={14} className="mr-2" />
                Save
              </Button>
              <Button onClick={cancelEdit} variant="outline">
                <X size={14} className="mr-2" />
                Cancel
              </Button>
            </div>
          </div>
        ) : (
          <div className="space-y-2">
            <div><strong>Title:</strong> {data.title}</div>
            <div><strong>Subtitle:</strong> {data.subtitle}</div>
            <div><strong>Logo:</strong> {data.logoText}</div>
          </div>
        )}
      </Card>

      {/* Sections Editor */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold">Questionnaire Sections</h3>
        {data.sections.map((section) => (
          <Card key={section.id} className={`p-6 ${!section.isVisible ? 'opacity-50' : ''}`}>
            <div className="flex justify-between items-start mb-4">
              <div className="flex items-center gap-2">
                <div className={`w-3 h-3 rounded-full ${section.isVisible ? 'bg-green-500' : 'bg-gray-400'}`} />
                <h4 className="font-semibold">{section.title}</h4>
              </div>
              <div className="flex gap-1">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => toggleSectionVisibility(section.id)}
                  className="p-1 h-8 w-8"
                >
                  {section.isVisible ? <Eye size={14} /> : <EyeOff size={14} />}
                </Button>
                <Button 
                  size="sm" 
                  variant="outline" 
                  onClick={() => startEdit(`section-${section.id}`, {
                    title: section.title,
                    description: section.description
                  })}
                  className="p-1 h-8 w-8"
                >
                  <Edit size={14} />
                </Button>
                {section.id !== 'section1' && section.id !== 'section2' && (
                  <Button 
                    size="sm" 
                    variant="outline" 
                    onClick={() => deleteSection(section.id)}
                    className="p-1 h-8 w-8 text-red-600"
                  >
                    <Trash2 size={14} />
                  </Button>
                )}
              </div>
            </div>

            {editingItem === `section-${section.id}` ? (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Section Title:</label>
                  <input
                    type="text"
                    value={editForm.title || ''}
                    onChange={(e) => setEditForm(prev => ({ ...prev, title: e.target.value }))}
                    className="w-full p-2 border border-gray-300 rounded-md"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Description (optional):</label>
                  <textarea
                    value={editForm.description || ''}
                    onChange={(e) => setEditForm(prev => ({ ...prev, description: e.target.value }))}
                    className="w-full p-2 border border-gray-300 rounded-md h-20 resize-none"
                  />
                </div>
                <div className="flex gap-2">
                  <Button onClick={saveEdit} className="bg-green-600 hover:bg-green-700">
                    <Save size={14} className="mr-2" />
                    Save
                  </Button>
                  <Button onClick={cancelEdit} variant="outline">
                    <X size={14} className="mr-2" />
                    Cancel
                  </Button>
                </div>
              </div>
            ) : (
              <div>
                {section.description && (
                  <p className="text-gray-600 mb-4">{section.description}</p>
                )}
                <div className="space-y-3">
                  <h5 className="font-medium">Questions ({section.questions.length}):</h5>
                  {section.questions.map((question) => (
                    <div key={question.id} className={`p-3 border rounded-md ${!question.isVisible ? 'opacity-50' : ''}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <div className={`w-2 h-2 rounded-full ${question.isVisible ? 'bg-green-500' : 'bg-gray-400'}`} />
                            <span className="font-medium text-sm">{question.title}</span>
                          </div>
                          <div className="text-xs text-gray-500 ml-4">
                            Type: {question.type} ‚Ä¢ Options: {question.options?.length || 0}
                          </div>
                        </div>
                        <div className="flex gap-1">
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => toggleQuestionVisibility(section.id, question.id)}
                            className="p-1 h-6 w-6"
                          >
                            {question.isVisible ? <Eye size={10} /> : <EyeOff size={10} />}
                          </Button>
                          <Button 
                            size="sm" 
                            variant="outline" 
                            onClick={() => startEdit(`question-${section.id.replace('section', '')}-${question.id.split('-')[1]}`, {
                              title: question.title,
                              placeholder: question.placeholder
                            })}
                            className="p-1 h-6 w-6"
                          >
                            <Edit size={10} />
                          </Button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </Card>
        ))}
      </div>

      {/* Footer Editor */}
      <Card className="p-6">
        <div className="flex justify-between items-start mb-4">
          <h3 className="text-lg font-semibold">Questionnaire Footer</h3>
          <Button 
            size="sm" 
            variant="outline" 
            onClick={() => startEdit('footer', data.footer)}
          >
            <Edit size={14} />
          </Button>
        </div>

        {editingItem === 'footer' ? (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">Thank You Title:</label>
              <input
                type="text"
                value={editForm.thankYouTitle || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, thankYouTitle: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Thank You Message:</label>
              <textarea
                value={editForm.thankYouMessage || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, thankYouMessage: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md h-20 resize-none"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Tagline:</label>
              <input
                type="text"
                value={editForm.tagline || ''}
                onChange={(e) => setEditForm(prev => ({ ...prev, tagline: e.target.value }))}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div className="flex gap-2">
              <Button onClick={saveEdit} className="bg-green-600 hover:bg-green-700">
                <Save size={14} className="mr-2" />
                Save
              </Button>
              <Button onClick={cancelEdit} variant="outline">
                <X size={14} className="mr-2" />
                Cancel
              </Button>
            </div>
          </div>
        ) : (
          <div className="space-y-2">
            <div><strong>Thank You Title:</strong> {data.footer.thankYouTitle}</div>
            <div><strong>Message:</strong> {data.footer.thankYouMessage}</div>
            <div><strong>Tagline:</strong> {data.footer.tagline}</div>
          </div>
        )}
      </Card>

      {/* Usage Instructions */}
      <Card className="p-6 bg-amber-50 border-amber-200">
        <h3 className="text-lg font-semibold mb-3 text-amber-800">How to Use Content Manager</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-amber-700">
          <div>
            <h4 className="font-semibold mb-2">Editing Content:</h4>
            <ul className="space-y-1 list-disc list-inside">
              <li>Click edit icon on any section to modify text</li>
              <li>Use visibility toggles to show/hide content</li>
              <li>Add new sections for additional questions</li>
              <li>Preview changes in real-time</li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-2">Management:</h4>
            <ul className="space-y-1 list-disc list-inside">
              <li>Green dots indicate visible content</li>
              <li>Export configuration for backup</li>
              <li>Changes auto-save to browser storage</li>
              <li>Delete custom sections (not default ones)</li>
            </ul>
          </div>
        </div>
      </Card>
    </div>
  );
}